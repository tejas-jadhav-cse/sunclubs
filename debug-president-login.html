<!DOCTYPE html>
<html>
<head>
    <title>President Login Debug Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config-manager.js"></script>
    <script src="js/logger.js"></script>
    <script src="js/supabase-config.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .pass { color: green; }
        .fail { color: red; }
        .warn { color: orange; }
        .info { color: blue; }
        .test-form { margin: 20px 0; padding: 15px; background: #f5f5f5; }
        input, button { margin: 5px; padding: 8px; }
        #results { margin: 20px 0; }
    </style>
</head>
<body>
    <h1>President Login Debug Test</h1>
    
    <div class="test-section">
        <h2>1. Configuration Tests</h2>
        <div id="config-tests"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Database Connection Test</h2>
        <div id="db-tests"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Authentication Test</h2>
        <div class="test-form">
            <h3>Test Login</h3>
            <input type="email" id="test-email" placeholder="Email" value="test@example.com">
            <input type="password" id="test-password" placeholder="Password" value="testpassword">
            <button onclick="testLogin()">Test Login</button>
        </div>
        <div id="auth-tests"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Database Structure Test</h2>
        <div id="structure-tests"></div>
    </div>
    
    <div id="results"></div>
    
    <script>
        let supabaseClient = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            runAllTests();
        });
        
        function log(message, type = 'info', containerId = 'results') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        async function runAllTests() {
            log('üîÑ Starting comprehensive tests...', 'info');
            
            // Test 1: Configuration
            await testConfiguration();
            
            // Test 2: Database connection
            await testDatabaseConnection();
            
            // Test 3: Database structure
            await testDatabaseStructure();
            
            log('‚úÖ All tests completed!', 'info');
        }
        
        async function testConfiguration() {
            log('Testing configuration...', 'info', 'config-tests');
            
            try {
                // Test config manager
                if (typeof configManager !== 'undefined') {
                    log('‚úÖ ConfigManager loaded', 'pass', 'config-tests');
                    
                    const config = configManager.getSupabaseConfig();
                    log(`üìã Supabase URL: ${config.url ? '‚úÖ Set' : '‚ùå Missing'}`, 
                        config.url ? 'pass' : 'fail', 'config-tests');
                    log(`üîë Supabase Key: ${config.anonKey ? '‚úÖ Set' : '‚ùå Missing'}`, 
                        config.anonKey ? 'pass' : 'fail', 'config-tests');
                    
                    if (config.url) {
                        log(`üåê URL: ${config.url}`, 'info', 'config-tests');
                    }
                } else {
                    log('‚ùå ConfigManager not loaded', 'fail', 'config-tests');
                }
                
                // Test supabase client creation
                if (typeof window.createSupabaseClient === 'function') {
                    log('‚úÖ createSupabaseClient function available', 'pass', 'config-tests');
                    
                    supabaseClient = window.createSupabaseClient();
                    if (supabaseClient) {
                        log('‚úÖ Supabase client created successfully', 'pass', 'config-tests');
                        log(`üîó Client URL: ${supabaseClient.supabaseUrl}`, 'info', 'config-tests');
                    } else {
                        log('‚ùå Failed to create Supabase client', 'fail', 'config-tests');
                    }
                } else {
                    log('‚ùå createSupabaseClient function not available', 'fail', 'config-tests');
                }
                
            } catch (error) {
                log(`‚ùå Configuration test error: ${error.message}`, 'fail', 'config-tests');
            }
        }
        
        async function testDatabaseConnection() {
            log('Testing database connection...', 'info', 'db-tests');
            
            if (!supabaseClient) {
                log('‚ùå No Supabase client available for testing', 'fail', 'db-tests');
                return;
            }
            
            try {
                // Test basic connection with a simple query
                const { data, error } = await supabaseClient
                    .from('club_applications')
                    .select('count(*)', { count: 'exact', head: true });
                
                if (error) {
                    log(`‚ö†Ô∏è Database connection test: ${error.message}`, 'warn', 'db-tests');
                    if (error.message.includes('relation') && error.message.includes('does not exist')) {
                        log('üí° Suggestion: Run setup-database.sql first', 'info', 'db-tests');
                    }
                } else {
                    log('‚úÖ Database connection successful', 'pass', 'db-tests');
                    log(`üìä Found ${data || 0} applications in database`, 'info', 'db-tests');
                }
            } catch (error) {
                log(`‚ùå Database connection error: ${error.message}`, 'fail', 'db-tests');
            }
        }
        
        async function testDatabaseStructure() {
            log('Testing database structure...', 'info', 'structure-tests');
            
            if (!supabaseClient) {
                log('‚ùå No Supabase client available for testing', 'fail', 'structure-tests');
                return;
            }
            
            // Test for clubs table
            try {
                const { data, error } = await supabaseClient
                    .from('clubs')
                    .select('count(*)', { count: 'exact', head: true });
                
                if (error) {
                    log(`‚ùå clubs table not found: ${error.message}`, 'fail', 'structure-tests');
                    log('üí° Run setup-president-auth.sql to create missing tables', 'info', 'structure-tests');
                } else {
                    log('‚úÖ clubs table exists', 'pass', 'structure-tests');
                }
            } catch (error) {
                log(`‚ùå clubs table test error: ${error.message}`, 'fail', 'structure-tests');
            }
            
            // Test for club_presidents table
            try {
                const { data, error } = await supabaseClient
                    .from('club_presidents')
                    .select('count(*)', { count: 'exact', head: true });
                
                if (error) {
                    log(`‚ùå club_presidents table not found: ${error.message}`, 'fail', 'structure-tests');
                    log('üí° Run setup-president-auth.sql to create missing tables', 'info', 'structure-tests');
                } else {
                    log('‚úÖ club_presidents table exists', 'pass', 'structure-tests');
                }
            } catch (error) {
                log(`‚ùå club_presidents table test error: ${error.message}`, 'fail', 'structure-tests');
            }
        }
        
        async function testLogin() {
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            
            log(`üîê Testing login with: ${email}`, 'info', 'auth-tests');
            
            if (!supabaseClient) {
                log('‚ùå No Supabase client available for login test', 'fail', 'auth-tests');
                return;
            }
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    log(`‚ö†Ô∏è Auth error (expected for test credentials): ${error.message}`, 'warn', 'auth-tests');
                    log(`üìã Error code: ${error.status || 'N/A'}`, 'info', 'auth-tests');
                    
                    if (error.message.includes('Invalid login credentials')) {
                        log('‚úÖ Authentication system is working (credentials just invalid)', 'pass', 'auth-tests');
                        log('üí° Create a real user account in Supabase Auth to test successful login', 'info', 'auth-tests');
                    }
                } else {
                    log('‚úÖ Login successful!', 'pass', 'auth-tests');
                    log(`üë§ User ID: ${data.user.id}`, 'info', 'auth-tests');
                    log(`üìß User Email: ${data.user.email}`, 'info', 'auth-tests');
                    
                    // Test club president lookup
                    setTimeout(async () => {
                        try {
                            const { data: presidentData, error: presidentError } = await supabaseClient
                                .from('club_presidents')
                                .select('*')
                                .eq('user_id', data.user.id);
                                
                            if (presidentError) {
                                log(`‚ö†Ô∏è President lookup error: ${presidentError.message}`, 'warn', 'auth-tests');
                            } else {
                                log(`üëë Found ${presidentData.length} president record(s)`, 'info', 'auth-tests');
                            }
                        } catch (e) {
                            log(`‚ùå President lookup error: ${e.message}`, 'fail', 'auth-tests');
                        }
                    }, 1000);
                }
            } catch (error) {
                log(`‚ùå Login test error: ${error.message}`, 'fail', 'auth-tests');
            }
        }
    </script>
</body>
</html>
